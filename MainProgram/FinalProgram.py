import os
import openai
from PIL import Image
import streamlit as st
from openai.error import InvalidRequestError

import nltk
from nltk.corpus import stopwords
from nltk.tokenize import word_tokenize
from konlpy.tag import Okt
import re

#keyword
import numpy as np
import itertools
from sklearn.feature_extraction.text import CountVectorizer
from sklearn.metrics.pairwise import cosine_similarity
from sentence_transformers import SentenceTransformer


regex = r"[^a-zA-Z0-9 ]"

def StopWord(sentence):
    subst = ""
    sentence = re.sub(regex, subst, sentence)
    print(sentence)

    stop_words = set(stopwords.words('english'))

    word_tokens = word_tokenize(sentence)

    result = []
    for word in word_tokens:
        if word not in stop_words:
            result.append(word)

    print('ë¶ˆìš©ì–´ ì œê±° ì „:',word_tokens)
    print('ë¶ˆìš©ì–´ ì œê±° í›„:',result)

    print(result[0])

    st = ",".join(result)
    print(st)
    return st

def KeyWordFun(doc):
    n_gram_range = (3, 3)
    stop_words = "english"

    count = CountVectorizer(ngram_range=n_gram_range, stop_words=stop_words).fit([doc])
    candidates = count.get_feature_names_out()

    #print('trigram ê°œìˆ˜ :',len(candidates))
    #print('trigram ë‹¤ì„¯ê°œë§Œ ì¶œë ¥ :',candidates[:5])

    model = SentenceTransformer('distilbert-base-nli-mean-tokens')
    doc_embedding = model.encode([doc])
    candidate_embeddings = model.encode(candidates)

    top_n = 3
    distances = cosine_similarity(doc_embedding, candidate_embeddings)
    keywords = [candidates[index] for index in distances.argsort()[0][-top_n:]]

    ss = ",".join(keywords)
    print(ss)
    print(keywords)
    return ss

openai.api_key = 'insert key'
messages = []
#tt= []
#chatGPT

def openai_completion(prompt):
    response = openai.Completion.create(
      #model="gpt-3.5-turbo",
      model="text-davinci-003",
      prompt=prompt,
      max_tokens=150,
      temperature=0.5
    )
    return response['choices'][0]['text']

#DALLE
def openai_image(prompt):
    response = openai.Image.create(
      prompt=prompt,
      n=2,
      size="1024x1024"
    )
    image_url = response['data'][0]['url']
    return image_url


try:
    

    format_type = st.sidebar.selectbox('Choose Option',["Basic","First Sentence & StopWord","KeyWord","First Sentence","Summary"])

   #Basic : ì •ì œ ì•ˆí•¨
    if format_type == "Basic":
        st.title("Basic")
        input_text = st.text_area("**í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”** ğŸ™‹",height=60)
        
        input_button = st.button("í™•ì¸!")
        openai_answer = openai_completion(input_text)
        
        tt = openai_answer

        if input_button:
            #st.write(openai_answer)
            st.write(tt)
        

       
        print('ONE!!',openai_answer)
        print('tt',tt)

        if st.button("ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°... ğŸ ğŸš€"):
            print('imga tt',tt)            
            image_url = openai_image(tt)
            print(image_url)
            st.image(image_url, caption='Generated by DALLE')
        else:
            st.warning("í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”! âš ")        
    
    # First Sentence & StopWord : ì²«ë¬¸ì¥ ì„ íƒ + ë¶ˆìš©ì–´ ì œê±° (ë‹¨ì–´ë§Œ)
    elif format_type == "First Sentence & StopWord":
        st.title("First Sentence & StopWord")
        input_text = st.text_area("**í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”** ğŸ™‹",height=60)
        
        input_button = st.button("í™•ì¸!")
        openai_answer = openai_completion(input_text)
        
        tt = openai_answer

        if input_button:
            #st.write(openai_answer)
            st.write(tt)
        

     
        print('ONE!!',openai_answer)
        print('tt',tt)
        

        if st.button("ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°... ğŸ ğŸš€"):
            #image_url = openai_image(openai_answer)
            print('imga tt',tt)
            
            # ì²« ë¬¸ì¥ë§Œ ê°€ì ¸ì˜¤ê¸°
            ll = tt.split('.')  
            # ì¤‘ê°„ì— ttë¥¼ í…ìŠ¤íŠ¸ ë§ˆì´ë‹ => í•¨ìˆ˜ ë„£ê¸°
            print('fisrt text',ll[0])
            tt = StopWord(ll[0])
            print('StopWord tt',tt)

            
            image_url = openai_image(tt)
            print(image_url)
            st.image(image_url, caption='Generated by DALLE')
        else:
            st.warning("í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”! âš ")        
        
    
    #KeyWord : í•µì‹¬í‚¤ì›Œë“œ ì¶”ì¶œ (, ë¡œ ì—°ê²°)
    elif format_type == "KeyWord" :
        st.title("KeyWord")
        input_text = st.text_area("**í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”**ğŸ™‹",height=60)
        input_button = st.button("Go answer")
        openai_answer = openai_completion(input_text)
        
        tt = openai_answer

        if input_button:
            #st.write(openai_answer)
            st.write(tt)
        

     
        print('ONE!!',openai_answer)
        print('tt',tt)
        

        if st.button("ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°... ğŸ ğŸš€"):
            #image_url = openai_image(openai_answer)
            print('imga tt',tt)
            
            tt = KeyWordFun(tt)
            print('Keyword',tt)
            image_url = openai_image(tt)
            print(image_url)
            st.image(image_url, caption='Generated by DALLE')
        else:
            st.warning("í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”! âš ")
    
    #First Sentence : ì²«ë¬¸ì¥ë§Œ ì„ íƒ
    elif format_type == "First Sentence":
        st.title("First Sentence")
        input_text = st.text_area("**í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”** ğŸ™‹",height=60)
        
        input_button = st.button("Go answer")
        openai_answer = openai_completion(input_text)
        
        tt = openai_answer

        if input_button:
            #st.write(openai_answer)
            st.write(tt) 
        print('ONE!!',openai_answer)
        print('tt',tt)
        if st.button("ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°... ğŸ ğŸš€"):
            #image_url = openai_image(openai_answer)
            print('imga tt',tt)
            
            # ì²« ë¬¸ì¥ë§Œ ê°€ì ¸ì˜¤ê¸°
            ll = tt.split('.')  
            # ì¤‘ê°„ì— ttë¥¼ í…ìŠ¤íŠ¸ ë§ˆì´ë‹ => í•¨ìˆ˜ ë„£ê¸°
            print('fisrt text',ll[0])
            tt = ll[0]

            
            image_url = openai_image(tt)
            print(image_url)
            st.image(image_url, caption='Generated by DALLE')
        else:
            st.warning("í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”! âš ")
        


    # Summary : ìì—°ì–´ ê²°ê³¼ ìš”ì•½ => chatGPT ì— ë¬¼ì–´ë³´ê¸°?
    else :
        inputex = ''


except InvalidRequestError as e:
    print('error!!!')
    st.markdown("It looks like this request may not follow DALL-E content policy.  \nAsk me the question again")
    
    
    
    
    ì´ì¬ì˜ í˜•íƒœì†Œë¥¼ ë¶„ì„í•˜ëŠ”  POS Tagging
    
    ì¶”ê°€ì ì¸ ì½”ë“œ ì…ë‹ˆë‹¤. ì¶œì²˜ sumit Raj íŒŒì´ì¬ìœ¼ë¡œ ì±—ë´‡ ë§Œë“¤ê¸° ì €ì 
    
    nlp = spacy.load('en') // spacy ì˜ì–´ ëª¨ë¸ì„ íŒŒì´ì¬ ì˜¤ë¸Œì íŠ¸ì— ë¡œë“œ
    doc = nlp(u'I am learning how to build chatbots') // í† í°ì„ ìœ„í•œ doc ì˜¤ë¸Œì íŠ¸ ìƒì„±
    for token in doc:
            print(token.text,token.pos_)   // í† í°ê³¼ í˜•íƒœì†Œ ê²°ê³¼ë¥¼ ì¶œë ¥
    
